#!/usr/bin/env ruby
# frozen_string_literal: true

require "tmpdir"

app_root = File.expand_path("#{__dir__}/..")
prefix_letter = File.basename(app_root)[0]
fantasticon_bin = "#{app_root}/node_modules/.bin/fantasticon"

unless File.exist?(fantasticon_bin)
  `cd __dir__; ./yarn install`
end

hbs_template = <<~HBS
  // Generated by bin/icons, don't edit by hand

  ${{ name }}-font: "{{ name }}";

  @font-face {
    font-family: ${{ name }}-font;
    src: font-url('icons.woff2') format('woff2'), font-url('icons.woff') format('woff');
  }

  @mixin icon-style {
    font-family: {{ name }} !important;
    speak: none;
    font-style: normal;
    font-weight: normal;
    font-variant: normal;
    text-transform: none;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;

    &, &:hover, &:focus {
      text-decoration: none !important;
    }
  }

  ${{ name }}-map: (
  {{# each codepoints }}
    {{ @key }}: "\\\\{{ codepoint this }}",
  {{/ each }}
  );

  .#{prefix_letter}-ui-icon {
    @include icon-style;
  }
  {{# each codepoints }}

  .#{prefix_letter}-ui-icon--{{ @key }}:before {
    content: map-get(${{ ../name }}-map, "{{ @key }}");
  }
  {{/ each }}
HBS

Dir.mktmpdir do |tmp|
  File.open("#{tmp}/fantasticon.scss.hbs", "w") do |file|
    file.write hbs_template
  end

  File.open("#{tmp}/.fantasticonrc", "w") do |file|
    file.write <<~JAVASCRIPT
      module.exports = {
        inputDir: '#{__dir__}/../data/icons',
        outputDir: '#{tmp}', // (required)
        fontTypes: ['woff', 'woff2'],
        assetTypes: ['scss'],
        fontsUrl: '/fonts',
        prefix: '#{prefix_letter}-ui-icon-',
        // Use a custom Handlebars template
        templates: {
          scss: './fantasticon.scss.hbs'
        },
      };
    JAVASCRIPT
  end

  `cd "#{tmp}" || exit 0; #{fantasticon_bin}`
  FileUtils.cp "#{tmp}/icons.scss", "#{app_root}/app/assets/stylesheets/_icons.scss"
  puts "Updated #{app_root}/app/assets/stylesheets/_icons.scss"
  FileUtils.cp "#{tmp}/icons.woff", "#{app_root}/app/assets/fonts/icons.woff"
  puts "Updated #{app_root}/app/assets/fonts/icons.woff"
  FileUtils.cp "#{tmp}/icons.woff2", "#{app_root}/app/assets/fonts/icons.woff2"
  puts "Updated #{app_root}/app/assets/fonts/icons.woff2"
end
